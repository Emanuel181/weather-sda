{% extends "base.html" %}

{% block title %}
  Favorite Cities
{% endblock %}

{% block content %}
<div class="container">
  <h2 class="mb-4 text-center">Your Favorite Cities</h2>

  <!-- Search bar to filter favorite cities -->
  <div class="input-group mb-4" style="max-width: 400px; margin: auto;">
    <input type="text" id="searchFavorites" class="form-control" placeholder="Search favorite cities...">
    <button class="btn btn-outline-secondary" onclick="resetSearch()">Clear</button>
  </div>

  {% if favorites %}
    <ul class="list-group animate__animated animate__fadeIn" id="favoritesList">
      {% for city in favorites %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <span>{{ city }}</span>
          <div>
            <!-- 5-Day Forecast button -->
            <button class="btn btn-sm btn-success me-2" onclick="showForecast('{{ city }}')">5-Day Forecast</button>
            <!-- Check Air Quality button -->
            <button class="btn btn-sm btn-info me-2" onclick="checkAirQuality('{{ city }}')">Check Air Quality</button>
            <!-- View on Map button -->
            <button class="btn btn-sm btn-secondary me-2" onclick="viewOnMap('{{ city }}')">View on Map</button>
            <!-- Remove button -->
            <button class="btn btn-sm btn-danger" onclick="removeFavorite('{{ city }}')">Remove</button>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="text-muted animate__animated animate__lightSpeedInLeft text-center">
      No favorite cities yet. Try searching on the <a href="{{ url_for('index') }}">main page</a> and add some!
    </p>
  {% endif %}
</div>

<!-- Modals for Forecast and AQI -->
<div class="modal fade" id="dataModal" tabindex="-1" aria-labelledby="dataModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dataModalLabel">City Data</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <canvas id="dataChart" style="width: 100%; height: 300px;"></canvas>
        <p id="modalContent" class="mt-3"></p>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const searchFavoritesInput = document.getElementById("searchFavorites");
    const favoritesList = document.getElementById("favoritesList");

    // Filter favorites by search input
    searchFavoritesInput.addEventListener("input", function () {
      const filter = searchFavoritesInput.value.toLowerCase();
      const items = favoritesList.querySelectorAll("li");
      items.forEach((item) => {
        const cityName = item.querySelector("span").textContent.toLowerCase();
        if (cityName.includes(filter)) {
          item.style.display = "flex";
        } else {
          item.style.display = "none";
        }
      });
    });

    // Reset search bar and show all favorites
    window.resetSearch = function () {
      searchFavoritesInput.value = "";
      const items = favoritesList.querySelectorAll("li");
      items.forEach((item) => (item.style.display = "flex"));
    };

    // Show 5-Day Forecast
    window.showForecast = async function (city) {
      try {
        const resp = await fetch(`/api/forecast?city=${encodeURIComponent(city)}`);
        const data = await resp.json();
        if (data.error || !data.forecast) {
          alert("Could not fetch forecast data.");
          return;
        }

        const labels = data.forecast.map(item => item.date);
        const temps = data.forecast.map(item => item.temp);

        const ctx = document.getElementById("dataChart").getContext("2d");
        new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [{
              label: "Temperature (Â°C)",
              data: temps,
              borderColor: "rgba(75, 192, 192, 1)",
              backgroundColor: "rgba(75, 192, 192, 0.2)",
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });

        const modal = new bootstrap.Modal(document.getElementById("dataModal"));
        document.getElementById("dataModalLabel").textContent = `5-Day Forecast for ${city}`;
        document.getElementById("modalContent").textContent = "";
        modal.show();
      } catch (error) {
        console.error("Error fetching forecast:", error);
      }
    };

    // Check Air Quality Index (AQI)
    window.checkAirQuality = async function (city) {
      try {
        const resp = await fetch(`/api/aqi?city=${encodeURIComponent(city)}`);
        const data = await resp.json();
        if (data.error || !data.aqi) {
          alert("Could not fetch AQI data.");
          return;
        }

        const modal = new bootstrap.Modal(document.getElementById("dataModal"));
        document.getElementById("dataModalLabel").textContent = `Air Quality Index for ${city}`;
        document.getElementById("modalContent").textContent = `AQI Level: ${data.aqi} - ${data.description}`;
        document.getElementById("dataChart").style.display = "none";
        modal.show();
      } catch (error) {
        console.error("Error fetching AQI:", error);
      }
    };

    // View on Map
    window.viewOnMap = function (city) {
      const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(city)}`;
      window.open(mapUrl, "_blank");
    };

    // Remove Favorite
    window.removeFavorite = function (city) {
      if (confirm(`Are you sure you want to remove ${city} from your favorites?`)) {
        fetch(`/remove_favorite?city=${encodeURIComponent(city)}`, { method: "DELETE" })
          .then(response => {
            if (response.ok) {
              alert(`${city} removed from favorites.`);
              location.reload();
            } else {
              alert("Failed to remove the city.");
            }
          })
          .catch(error => console.error("Error removing favorite:", error));
      }
    };
  });
</script>
{% endblock %}
