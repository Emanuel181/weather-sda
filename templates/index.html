{% extends "base.html" %}

{% block title %}
  Weather + Chat + Forecast
{% endblock %}

{% block content %}
  <h1 class="mb-4">Check the Weather (No Refresh)</h1>

  <!-- Input group with manual entry, Get Weather, and Detect Location buttons -->
  <div class="d-flex mb-3" style="max-width: 400px;">
    <input type="text" id="cityInput" class="form-control animate__animated animate__bounceInLeft" placeholder="Enter city name" />
    <button id="getWeatherBtn" class="btn btn-primary animate__animated animate__bounceInRight ms-2">Get Weather</button>
    <button id="detectLocationBtn" class="btn btn-secondary ms-2">Detect Location</button>
  </div>

  <!-- Add to Favorites Button -->
  <div class="d-flex align-items-center mb-4">
    <button id="addFavoriteBtn" class="btn btn-warning d-none me-3">Add to Favorites</button>
    <form method="POST" action="{{ url_for('add_favorite') }}" style="display: none;" id="favoritesForm">
      <input type="hidden" name="favorite_city" id="favoriteCityInput" />
    </form>
  </div>

  <!-- Temperature unit toggle button -->
  <button id="toggleUnitBtn" class="btn btn-outline-info mb-3">Toggle 째C/째F (Current: {{ temp_unit }})</button>

  <!-- Weather result with icon -->
  <div id="weatherResult" class="alert d-none" style="min-height: 50px;">
    <img id="weatherIcon" src="" alt="Weather Icon" style="display: none; vertical-align: middle; margin-right: 10px;" />
    <span id="weatherText"></span>
  </div>

  <!-- Sunrise and Sunset -->
  <div id="sunTimes" class="mt-3">
    <p><strong>Sunrise:</strong> <span id="sunriseTime"></span></p>
    <p><strong>Sunset:</strong> <span id="sunsetTime"></span></p>
  </div>

  <hr />

  <!-- 5-Day Forecast Chart -->
  <div id="forecastSection" style="display:none; margin-bottom:20px; width: 400px; height: 220px;">
    <h3 class="mb-3">5-Day Forecast</h3>
    <canvas id="forecastChart" width="400" height="200" style="width: 400px; height: 200px;"></canvas>
  </div>

  <hr/>

  <!-- Real-Time Chat Section -->
  <div class="chat-section">
    <h2 class="mb-3">Simple Chat</h2>
    <div id="chatMessages" class="chat-messages mb-3 p-2" style="border: 1px solid #ddd; max-height: 200px; overflow-y: auto; border-radius: 5px;"></div>
    <div class="input-group" style="max-width: 400px;">
      <input type="text" id="chatInput" class="form-control" placeholder="Enter chat message..." />
      <button id="sendChatBtn" class="btn btn-success">Send</button>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">Notification</strong>
        <small>Now</small>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toastBody"></div>
    </div>
  </div>


<!-- Socket.IO client, Chart.js, and custom scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    let tempUnit = "{{ temp_unit }}";

    const socket = io();

    const sentMessages = new Set();

    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const sendChatBtn = document.getElementById("sendChatBtn");
    const typingIndicator = document.getElementById("typingIndicator");
    const cityInput = document.getElementById("cityInput");
    const getWeatherBtn = document.getElementById("getWeatherBtn");
    const detectLocationBtn = document.getElementById("detectLocationBtn");
    const toggleUnitBtn = document.getElementById("toggleUnitBtn");
    const addFavoriteBtn = document.getElementById("addFavoriteBtn");
    const favoritesForm = document.getElementById("favoritesForm");
    const favoriteCityInput = document.getElementById("favoriteCityInput");
    const weatherResult = document.getElementById("weatherResult");
    const weatherText = document.getElementById("weatherText");
    const weatherIcon = document.getElementById("weatherIcon");
    const sunriseTime = document.getElementById("sunriseTime");
    const sunsetTime = document.getElementById("sunsetTime");
    const forecastSection = document.getElementById("forecastSection");
    const forecastChartCanvas = document.getElementById("forecastChart");
    const toastBody = document.getElementById("toastBody");
    const toastEl = document.getElementById("liveToast");

    let forecastChart;
    let typingTimeout;

    socket.on("connect", () => console.log(`Connected to server with SID: ${socket.id}`));
    socket.on("connect_error", (error) => console.error("Connection Error:", error));
    // Listen for incoming chat messages
    socket.on("chat_message", ({ text, timestamp, sender }) => {
        appendMessage(text, timestamp, sender === socket.id ? "You" : sender);
    });

    // Listen for typing events
    socket.on("typing", ({ typing, sender }) => {
        if (sender === socket.id) return; // Ignore self-typing events
        typingIndicator.textContent = typing ? `${sender} is typing...` : "";
    });

    // Emit a chat message
    sendChatBtn.addEventListener("click", () => {
        const message = chatInput.value.trim();
        if (message) {
            const timestamp = new Date().toISOString();
            socket.emit("chat_message", { text: message, timestamp });
            chatInput.value = ""; // Clear the input box
        }
    });

    // Emit typing events
    chatInput.addEventListener("input", () => {
        socket.emit("typing", { typing: true });

        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            socket.emit("typing", { typing: false });
        }, 2000); // Stop typing after 2 seconds of no input
    });

    // Utility: Append a message to the chat box
    function appendMessage(text, timestamp, sender) {
        if (!text || !timestamp) return;

        const formattedTime = new Date(timestamp).toLocaleTimeString();
        const messageElement = document.createElement("p");
        messageElement.textContent = `[${formattedTime}] ${sender}: ${text}`;
        chatMessages.appendChild(messageElement);

        // Auto-scroll to the bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

  // Utility: Format timestamp into readable time
  function formatTimestamp(timestamp) {
    try {
      const date = new Date(timestamp);
      if (isNaN(date.getTime())) throw new Error("Invalid date");
      return date.toLocaleTimeString();
    } catch (error) {
      console.error("Invalid timestamp:", timestamp, error);
      return "Invalid Date";
    }
  }

    async function fetchWeather() {
      const city = cityInput.value.trim();
      if (!city) {
        showToast("Please enter a valid city.");
        return;
      }

      clearWeatherDisplay();
      setButtonLoading(getWeatherBtn, true);

      try {
        const response = await fetch(`/api/weather?city=${encodeURIComponent(city)}`);
        const data = await response.json();

        if (data.error) {
          displayWeatherError(data.error);
        } else {
          displayWeatherData(data);
          enableAddToFavorites(data.city);
          await fetchForecast(data.city);
          showToast("Weather data fetched successfully!");
        }
      } catch (error) {
        console.error("Request failed:", error);
        displayWeatherError(error.message || "Failed to fetch weather data.");
      } finally {
        setButtonLoading(getWeatherBtn, false);
      }
    }

    async function fetchForecast(city) {
      if (!city) {
        console.error("Invalid city for forecast request");
        return;
      }

      try {
        const response = await fetch(`/api/forecast?city=${encodeURIComponent(city)}`);
        const data = await response.json();

        if (data.forecast) {
          displayForecast(data.forecast);
        }
      } catch (error) {
        console.error("Forecast fetch failed:", error);
      }
    }

    function displayWeatherData(data) {
      weatherText.innerHTML = `<strong>Weather for ${data.city}:</strong> ${data.weather_info}`;
      if (data.icon) {
        weatherIcon.src = `https://openweathermap.org/img/wn/${data.icon}@2x.png`;
        weatherIcon.style.display = "inline";
      }
      if (data.sunrise) sunriseTime.textContent = formatTimestamp(data.sunrise);
      if (data.sunset) sunsetTime.textContent = formatTimestamp(data.sunset);

      weatherResult.classList.remove("d-none");
    }

    function displayForecast(forecast) {
      const labels = forecast.map((item) => item.date);
      const temps = forecast.map((item) => item.temp);

      if (forecastChart) {
        forecastChart.destroy();
      }

      forecastChart = new Chart(forecastChartCanvas, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: `Temperature (${tempUnit === "imperial" ? "째F" : "째C"})`,
              data: temps,
              borderColor: "rgba(54, 162, 235, 1)",
              backgroundColor: "rgba(54, 162, 235, 0.2)",
              fill: true,
            },
          ],
        },
        options: { responsive: true, maintainAspectRatio: false },
      });

      forecastSection.style.display = "block";
    }

    function clearWeatherDisplay() {
      weatherResult.classList.add("d-none");
      forecastSection.style.display = "none";
      sunriseTime.textContent = "";
      sunsetTime.textContent = "";
    }

    function displayWeatherError(message) {
      weatherResult.textContent = `Error: ${message}`;
      weatherResult.classList.remove("d-none");
    }

    function setButtonLoading(button, isLoading) {
      button.textContent = isLoading ? "Loading..." : button.getAttribute("data-original-text") || "Get Weather";
      button.disabled = isLoading;
    }

    function showToast(message) {
      toastBody.textContent = message;
      new bootstrap.Toast(toastEl).show();
    }

    function enableAddToFavorites(city) {
      if (city) {
        favoriteCityInput.value = city;
        addFavoriteBtn.classList.remove("d-none");
        addFavoriteBtn.onclick = () => favoritesForm.submit();
      } else {
        addFavoriteBtn.classList.add("d-none");
      }
    }

    getWeatherBtn.addEventListener("click", fetchWeather);
    detectLocationBtn.addEventListener("click", fetchWeather);
    toggleUnitBtn.addEventListener("click", fetchWeather);
  });
</script>



{% endblock %}