{% extends "base.html" %}

{% block title %}
  Weather + Chat + Forecast
{% endblock %}

{% block content %}
  <h1 class="mb-4">Check the Weather (No Refresh)</h1>

  <!-- Input group with manual entry, Get Weather, and Detect Location buttons -->
  <div class="d-flex mb-3" style="max-width: 400px;">
    <input type="text" id="cityInput" class="form-control animate__animated animate__bounceInLeft" placeholder="Enter city name" />
    <button id="getWeatherBtn" class="btn btn-primary animate__animated animate__bounceInRight ms-2">Get Weather</button>
    <button id="detectLocationBtn" class="btn btn-secondary ms-2">Detect Location</button>
  </div>

  <!-- Add to Favorites Button -->
  <div class="d-flex align-items-center mb-4">
    <button id="addFavoriteBtn" class="btn btn-warning d-none me-3">Add to Favorites</button>
    <form method="POST" action="{{ url_for('add_favorite') }}" style="display: none;" id="favoritesForm">
      <input type="hidden" name="favorite_city" id="favoriteCityInput" />
    </form>
  </div>

  <!-- Temperature unit toggle button -->
  <button id="toggleUnitBtn" class="btn btn-outline-info mb-3">Toggle °C/°F (Current: {{ temp_unit }})</button>

  <!-- Weather result with icon -->
  <div id="weatherResult" class="alert d-none" style="min-height: 50px;">
    <img id="weatherIcon" src="" alt="Weather Icon" style="display: none; vertical-align: middle; margin-right: 10px;" />
    <span id="weatherText"></span>
  </div>

  <!-- Sunrise and Sunset -->
  <div id="sunTimes" class="mt-3">
    <p><strong>Sunrise:</strong> <span id="sunriseTime"></span></p>
    <p><strong>Sunset:</strong> <span id="sunsetTime"></span></p>
  </div>

  <hr />

  <!-- 5-Day Forecast Chart -->
  <div id="forecastSection" style="display:none; margin-bottom:20px; width: 400px; height: 220px;">
    <h3 class="mb-3">5-Day Forecast</h3>
    <canvas id="forecastChart" width="400" height="200" style="width: 400px; height: 200px;"></canvas>
  </div>

  <hr/>

  <!-- Real-Time Chat Section -->
  <div class="chat-section">
    <h2 class="mb-3">Simple Chat</h2>
    <div id="chatMessages" class="chat-messages mb-3 p-2" style="border: 1px solid #ddd; max-height: 200px; overflow-y: auto; border-radius: 5px;"></div>
    <div class="input-group" style="max-width: 400px;">
      <input type="text" id="chatInput" class="form-control" placeholder="Enter chat message..." />
      <button id="sendChatBtn" class="btn btn-success">Send</button>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">Notification</strong>
        <small>Now</small>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toastBody"></div>
    </div>
  </div>


<!-- Socket.IO client, Chart.js, and custom scripts -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    let tempUnit = "{{ temp_unit }}"; // Temperature unit passed from the backend

    // Initialize Socket.IO
    const socket = io();
    socket.on("connect", function () {
      console.log("Connected to server with SID:", socket.id);
    });
    socket.on("connect_error", function (error) {
      console.error("Connection Error:", error);
    });
    socket.on("chat_message", function (data) {
      const chatBox = document.getElementById("chatMessages");
      const messageElement = document.createElement("p");
      messageElement.className = "animate__animated animate__fadeInUp";
      messageElement.textContent = data.message;
      chatBox.appendChild(messageElement);
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    const chatInput = document.getElementById("chatInput");
    const sendChatBtn = document.getElementById("sendChatBtn");

    sendChatBtn.addEventListener("click", function () {
      const message = chatInput.value.trim();
      if (message) {
        socket.emit("chat_message", { text: message });
        chatInput.value = "";
      }
    });

    // DOM Elements
    const cityInput = document.getElementById("cityInput");
    const getWeatherBtn = document.getElementById("getWeatherBtn");
    const detectLocationBtn = document.getElementById("detectLocationBtn");
    const toggleUnitBtn = document.getElementById("toggleUnitBtn");
    const addFavoriteBtn = document.getElementById("addFavoriteBtn");
    const favoritesForm = document.getElementById("favoritesForm");
    const favoriteCityInput = document.getElementById("favoriteCityInput");
    const weatherResult = document.getElementById("weatherResult");
    const weatherText = document.getElementById("weatherText");
    const weatherIcon = document.getElementById("weatherIcon");
    const sunriseTime = document.getElementById("sunriseTime");
    const sunsetTime = document.getElementById("sunsetTime");
    const forecastSection = document.getElementById("forecastSection");
    const toastBody = document.getElementById("toastBody");
    const toastEl = document.getElementById("liveToast");
    const forecastChartCanvas = document.getElementById("forecastChart");

    let forecastChart; // Store the chart instance

    // Enable the "Add to Favorites" button with the current city
    function enableAddToFavorites(city) {
      if (city) {
        favoriteCityInput.value = city;
        addFavoriteBtn.classList.remove("d-none");
        addFavoriteBtn.addEventListener("click", function () {
          favoritesForm.submit();
        });
      } else {
        addFavoriteBtn.classList.add("d-none");
      }
    }

    // Fetch Weather Data
    async function fetchWeather() {
      const city = cityInput.value.trim();
      if (!city) {
        showToast("Please enter a valid city.");
        return;
      }

      clearWeatherDisplay();
      setButtonLoading(getWeatherBtn, true);

      try {
        const response = await fetch(`/api/weather?city=${encodeURIComponent(city)}`);
        const data = await response.json();

        if (data.error) {
          displayWeatherError(data.error);
        } else {
          displayWeatherData(data);
          enableAddToFavorites(data.city);
          await fetchForecast(data.city);
          showToast("Weather data fetched successfully!");
          fireConfetti();
        }
      } catch (error) {
        console.error("Request failed:", error);
        displayWeatherError(error.message);
      } finally {
        setButtonLoading(getWeatherBtn, false);
      }
    }

    // Fetch Forecast Data
    async function fetchForecast(city) {
      if (!city) {
        console.error("Invalid city for forecast request");
        return;
      }

      try {
        const response = await fetch(`/api/forecast?city=${encodeURIComponent(city)}`);
        const data = await response.json();

        if (data.forecast) {
          displayForecast(data.forecast);
        }
      } catch (error) {
        console.error("Forecast fetch failed:", error);
      }
    }

    // Detect Location
    async function detectLocation() {
      if (!navigator.geolocation) {
        showToast("Geolocation is not supported by your browser.");
        return;
      }

      navigator.geolocation.getCurrentPosition(async function (position) {
        const { latitude, longitude } = position.coords;

        try {
          const response = await fetch(`/api/reverse_geocode?lat=${latitude}&lon=${longitude}`);
          const data = await response.json();

          if (data.error || !data.city) {
            showToast("Could not detect location.");
          } else {
            cityInput.value = data.city;
            fetchWeather();
          }
        } catch (error) {
          console.error("Reverse geocoding failed:", error);
          showToast("Unable to retrieve location.");
        }
      });
    }

    // Toggle Temperature Unit
    async function toggleUnit() {
      try {
        const response = await fetch("/toggle_unit", {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-Requested-With": "XMLHttpRequest" },
        });
        const data = await response.json();
        tempUnit = data.temp_unit;
        toggleUnitBtn.textContent = `Toggle °C/°F (Current: ${tempUnit})`;
        fetchWeather();
      } catch (error) {
        console.error("Toggle unit failed:", error);
        showToast("Error toggling unit.");
      }
    }

    // Display Weather Data
    function displayWeatherData(data) {
      weatherText.innerHTML = `<strong>Weather for ${data.city}:</strong> ${data.weather_info}`;
      if (data.icon) {
        weatherIcon.src = `https://openweathermap.org/img/wn/${data.icon}@2x.png`;
        weatherIcon.style.display = "inline";
      }
      if (data.sunrise) sunriseTime.textContent = formatTimestamp(data.sunrise);
      if (data.sunset) sunsetTime.textContent = formatTimestamp(data.sunset);

      weatherResult.classList.remove("d-none");
    }

    // Display Forecast Data
    function displayForecast(forecast) {
      const labels = forecast.map((item) => item.date);
      const temps = forecast.map((item) => item.temp);

      if (forecastChart) {
        forecastChart.destroy();
      }

      forecastChart = new Chart(forecastChartCanvas, {
        type: "line",
        data: {
          labels,
          datasets: [{ label: `Temperature (${tempUnit === "imperial" ? "°F" : "°C"})`, data: temps, borderColor: "rgba(54, 162, 235, 1)", backgroundColor: "rgba(54, 162, 235, 0.2)", fill: true }],
        },
        options: { responsive: false, maintainAspectRatio: false },
      });

      forecastSection.style.display = "block";
    }

    // Utility Functions
    function formatTimestamp(timestamp) {
      const date = new Date(timestamp * 1000);
      return `${date.getHours().toString().padStart(2, "0")}:${date.getMinutes().toString().padStart(2, "0")}`;
    }

    function showToast(message) {
      toastBody.textContent = message;
      new bootstrap.Toast(toastEl).show();
    }

    function clearWeatherDisplay() {
      weatherResult.classList.add("d-none");
      forecastSection.style.display = "none";
      sunriseTime.textContent = "";
      sunsetTime.textContent = "";
    }

    function displayWeatherError(message) {
      weatherResult.textContent = `Error: ${message}`;
      weatherResult.classList.remove("d-none");
    }

    function setButtonLoading(button, isLoading) {
      button.textContent = isLoading ? "Loading..." : button.getAttribute("data-original-text") || "Get Weather";
      button.disabled = isLoading;
    }

    function fireConfetti() {
      const duration = 1.5 * 1000;
      const end = Date.now() + duration;

      (function frame() {
        confetti({ particleCount: 5, startVelocity: 30, spread: 360, origin: { x: Math.random(), y: Math.random() * 0.2 } });
        if (Date.now() < end) requestAnimationFrame(frame);
      })();
    }

    // Attach Event Listeners
    getWeatherBtn.addEventListener("click", fetchWeather);
    detectLocationBtn.addEventListener("click", detectLocation);
    toggleUnitBtn.addEventListener("click", toggleUnit);
  });
</script>


{% endblock %}