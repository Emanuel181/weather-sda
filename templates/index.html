{% extends "base.html" %}

{% block title %}
  Weather + Chat + Forecast
{% endblock %}

{% block content %}
  <style>
    /* Background themes based on weather condition */
    .sunny-bg { background: linear-gradient(135deg, #fceabb, #f8b500); }
    .cloudy-bg { background: linear-gradient(135deg, #bdc3c7, #2c3e50); }
    .rainy-bg { background: linear-gradient(135deg, #a1c4fd, #c2e9fb); }
    .default-bg { background: #f5f5f5; }

    /* Dark mode styling */
    .dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }
    .dark-mode .btn {
      background-color: #424242;
      border-color: #616161;
      color: #e0e0e0;
    }
    .dark-mode .alert {
      background-color: #424242;
      border-color: #616161;
      color: #e0e0e0;
    }
    .dark-mode .favorites-list li {
      background-color: #333;
    }
    .dark-mode #autocompleteSuggestions {
      background-color: #333;
      color: #e0e0e0;
    }
    .dark-mode #autocompleteSuggestions a {
      color: #e0e0e0;
    }
    .dark-mode #autocompleteSuggestions a:hover {
      background-color: #444;
    }

    /* Autocomplete Suggestions Styling */
    #autocompleteSuggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      z-index: 1000;
      display: none;
      border: 1px solid #ccc;
      background-color: #fff;
      max-height: 200px;
      overflow-y: auto;
    }
    #autocompleteSuggestions a {
      display: block;
      padding: 5px 10px;
      cursor: pointer;
      text-decoration: none;
      color: #333;
    }
    #autocompleteSuggestions a:hover {
      background-color: #eee;
    }

    /* Loading Spinner Overlay */
    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      display: none;
    }
    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Favorites list styling */
    .favorites-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-wrap: wrap;
    }
    .favorites-list li {
      margin: 5px;
      padding: 5px 10px;
      background: #eee;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .favorites-list li span {
      flex-grow: 1;
    }
    .favorites-list li button {
      margin-left: 10px;
    }
  </style>

  <!-- Loading Spinner Overlay -->
  <div id="loadingSpinner" class="spinner-overlay">
    <div class="spinner"></div>
  </div>

  <h1 class="mb-4">Check the Weather (No Refresh)</h1>

  <!-- Input group with manual entry, Get Weather, and Detect Location buttons -->
  <div class="position-relative mb-3" style="max-width: 400px;">
    <input type="text" id="cityInput" class="form-control animate__animated animate__bounceInLeft" placeholder="Enter city name" autocomplete="off" />
    <!-- Autocomplete Suggestions Container -->
    <div id="autocompleteSuggestions"></div>
    <div class="mt-2">
      <button id="getWeatherBtn" class="btn btn-primary animate__animated animate__bounceInRight">Get Weather</button>
      <button id="detectLocationBtn" class="btn btn-secondary">Detect Location</button>
    </div>
  </div>

  <!-- Favorites List Section -->
  <div class="mb-4">
    <h5>Favorites:</h5>
    <ul id="favoritesList" class="favorites-list"></ul>
  </div>

  <!-- Add to Favorites Button (for manual addition) -->
  <div class="d-flex align-items-center mb-4">
    <button id="addFavoriteBtn" class="btn btn-warning d-none me-3">Add to Favorites</button>
    <form method="POST" action="{{ url_for('add_favorite') }}" style="display: none;" id="favoritesForm">
      <input type="hidden" name="favorite_city" id="favoriteCityInput" />
    </form>
  </div>

  <!-- Temperature unit toggle and Dark Mode toggle buttons -->
  <div class="mb-3">
    <button id="toggleUnitBtn" class="btn btn-outline-info">Toggle °C/°F (Current: {{ temp_unit }})</button>
    <button id="toggleDarkModeBtn" class="btn btn-outline-dark ms-2">Toggle Dark Mode</button>
  </div>

  <!-- Weather result with icon -->
  <div id="weatherResult" class="alert d-none" style="min-height: 50px;">
    <img id="weatherIcon" src="" alt="Weather Icon" style="display: none; vertical-align: middle; margin-right: 10px;" />
    <span id="weatherText"></span>
  </div>

  <!-- Detailed Weather Metrics -->
  <div id="weatherDetails" class="mb-3 d-none">
    <p><strong>Humidity:</strong> <span id="humidity"></span>%</p>
    <p><strong>Wind Speed:</strong> <span id="windSpeed"></span> m/s</p>
    <p><strong>Pressure:</strong> <span id="pressure"></span> hPa</p>
  </div>

  <!-- Share Weather Button (initially hidden) -->
  <div class="mb-3">
    <button id="shareWeatherBtn" class="btn btn-outline-success d-none">Share Weather</button>
  </div>

  <!-- Sunrise and Sunset -->
  <div id="sunTimes" class="mt-3">
    <p><strong>Sunrise:</strong> <span id="sunriseTime"></span></p>
    <p><strong>Sunset:</strong> <span id="sunsetTime"></span></p>
  </div>

  <hr />

  <!-- 5-Day Forecast Chart -->
  <div id="forecastSection" style="display:none; margin-bottom:20px; width: 400px; height: 220px;">
    <h3 class="mb-3">5-Day Forecast</h3>
    <canvas id="forecastChart" width="400" height="200" style="width: 400px; height: 200px;"></canvas>
  </div>

  <hr/>

  <!-- Real-Time Chat Section -->
  <div class="chat-section">
    <h2 class="mb-3">Simple Chat</h2>
    <div id="chatMessages" class="chat-messages mb-3 p-2" style="border: 1px solid #ddd; max-height: 200px; overflow-y: auto; border-radius: 5px;"></div>
    <div class="input-group" style="max-width: 400px;">
      <input type="text" id="chatInput" class="form-control" placeholder="Enter chat message..." />
      <button id="sendChatBtn" class="btn btn-success">Send</button>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">Notification</strong>
        <small>Now</small>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toastBody"></div>
    </div>
  </div>

  <!-- Socket.IO client, Chart.js, and custom scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      let tempUnit = "{{ temp_unit }}";
      const bodyEl = document.body;
      let lastWeatherData = null;  // Store the latest weather data for sharing

      // Check and apply dark mode from localStorage on load
      if (localStorage.getItem("darkMode") === "enabled") {
        bodyEl.classList.add("dark-mode");
      }

      const socket = io();

      const chatMessages = document.getElementById("chatMessages");
      const chatInput = document.getElementById("chatInput");
      const sendChatBtn = document.getElementById("sendChatBtn");
      const cityInput = document.getElementById("cityInput");
      const autocompleteSuggestions = document.getElementById("autocompleteSuggestions");
      const getWeatherBtn = document.getElementById("getWeatherBtn");
      const detectLocationBtn = document.getElementById("detectLocationBtn");
      const toggleUnitBtn = document.getElementById("toggleUnitBtn");
      const toggleDarkModeBtn = document.getElementById("toggleDarkModeBtn");
      const addFavoriteBtn = document.getElementById("addFavoriteBtn");
      const favoritesForm = document.getElementById("favoritesForm");
      const favoriteCityInput = document.getElementById("favoriteCityInput");
      const favoritesList = document.getElementById("favoritesList");
      const shareWeatherBtn = document.getElementById("shareWeatherBtn");

      const weatherResult = document.getElementById("weatherResult");
      const weatherText = document.getElementById("weatherText");
      const weatherIcon = document.getElementById("weatherIcon");
      const weatherDetails = document.getElementById("weatherDetails");
      const humidityEl = document.getElementById("humidity");
      const windSpeedEl = document.getElementById("windSpeed");
      const pressureEl = document.getElementById("pressure");
      const sunriseTime = document.getElementById("sunriseTime");
      const sunsetTime = document.getElementById("sunsetTime");
      const forecastSection = document.getElementById("forecastSection");
      const forecastChartCanvas = document.getElementById("forecastChart");
      const toastBody = document.getElementById("toastBody");
      const toastEl = document.getElementById("liveToast");
      const loadingSpinner = document.getElementById("loadingSpinner");

      let forecastChart;
      let typingTimeout;

      /*** Socket.IO Chat Logic ***/
      socket.on("connect", () => console.log(`Connected to server with SID: ${socket.id}`));
      socket.on("connect_error", (error) => console.error("Connection Error:", error));
      socket.on("chat_message", ({ text, timestamp, sender }) => {
        appendMessage(text, timestamp, sender === socket.id ? "You" : sender);
      });
      socket.on("typing", ({ typing, sender }) => {
        // Optionally implement a typing indicator.
      });
      sendChatBtn.addEventListener("click", () => {
        const message = chatInput.value.trim();
        if (message) {
          const timestamp = new Date().toISOString();
          socket.emit("chat_message", { text: message, timestamp });
          chatInput.value = "";
        }
      });
      chatInput.addEventListener("input", () => {
        socket.emit("typing", { typing: true });
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          socket.emit("typing", { typing: false });
        }, 2000);
      });
      function appendMessage(text, timestamp, sender) {
        if (!text || !timestamp) return;
        const formattedTime = new Date(timestamp).toLocaleTimeString();
        const messageElement = document.createElement("p");
        messageElement.textContent = `[${formattedTime}] ${sender}: ${text}`;
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      function formatTimestamp(timestamp) {
        try {
          const date = new Date(timestamp);
          if (isNaN(date.getTime())) throw new Error("Invalid date");
          return date.toLocaleTimeString();
        } catch (error) {
          console.error("Invalid timestamp:", timestamp, error);
          return "Invalid Date";
        }
      }

      /*** Weather and Forecast Fetching ***/
      async function fetchWeather() {
        const city = cityInput.value.trim();
        if (!city) {
          showToast("Please enter a valid city.");
          return;
        }
        clearWeatherDisplay();
        showSpinner(true);
        try {
          const response = await fetch(`/api/weather?city=${encodeURIComponent(city)}`);
          const data = await response.json();
          if (data.error) {
            displayWeatherError(data.error);
          } else {
            displayWeatherData(data);
            lastWeatherData = data; // Save the latest weather data for sharing
            enableAddToFavorites(data.city);
            shareWeatherBtn.classList.remove("d-none");
            await fetchForecast(data.city);
            showToast("Weather data fetched successfully!");
          }
        } catch (error) {
          console.error("Request failed:", error);
          displayWeatherError(error.message || "Failed to fetch weather data.");
        } finally {
          showSpinner(false);
        }
      }
      async function fetchForecast(city) {
        if (!city) {
          console.error("Invalid city for forecast request");
          return;
        }
        try {
          const response = await fetch(`/api/forecast?city=${encodeURIComponent(city)}`);
          const data = await response.json();
          if (data.forecast) {
            displayForecast(data.forecast);
          }
        } catch (error) {
          console.error("Forecast fetch failed:", error);
        }
      }
      function displayWeatherData(data) {
        weatherText.innerHTML = `<strong>Weather for ${data.city}:</strong> ${data.weather_info}`;
        if (data.icon) {
          weatherIcon.src = `https://openweathermap.org/img/wn/${data.icon}@2x.png`;
          weatherIcon.style.display = "inline";
        }
        if (data.humidity != null) {
          humidityEl.textContent = data.humidity;
          windSpeedEl.textContent = data.wind_speed;
          pressureEl.textContent = data.pressure;
          weatherDetails.classList.remove("d-none");
        }
        if (data.sunrise) sunriseTime.textContent = formatTimestamp(data.sunrise);
        if (data.sunset) sunsetTime.textContent = formatTimestamp(data.sunset);
        weatherResult.classList.remove("d-none");

        // Change background theme based on weather keywords.
        if (data.weather_info.toLowerCase().includes("sunny")) {
          bodyEl.className = "sunny-bg";
        } else if (data.weather_info.toLowerCase().includes("rain")) {
          bodyEl.className = "rainy-bg";
        } else if (data.weather_info.toLowerCase().includes("cloud")) {
          bodyEl.className = "cloudy-bg";
        } else {
          bodyEl.className = "default-bg";
        }
      }
      function displayForecast(forecast) {
        const labels = forecast.map((item) => item.date);
        const temps = forecast.map((item) => item.temp);
        if (forecastChart) {
          forecastChart.destroy();
        }
        forecastChart = new Chart(forecastChartCanvas, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: `Temperature (${tempUnit === "imperial" ? "°F" : "°C"})`,
                data: temps,
                borderColor: "rgba(54, 162, 235, 1)",
                backgroundColor: "rgba(54, 162, 235, 0.2)",
                fill: true,
              },
            ],
          },
          options: { responsive: true, maintainAspectRatio: false },
        });
        forecastSection.style.display = "block";
      }
      function clearWeatherDisplay() {
        weatherResult.classList.add("d-none");
        forecastSection.style.display = "none";
        weatherDetails.classList.add("d-none");
        sunriseTime.textContent = "";
        sunsetTime.textContent = "";
        shareWeatherBtn.classList.add("d-none");
      }
      function displayWeatherError(message) {
        weatherResult.textContent = `Error: ${message}`;
        weatherResult.classList.remove("d-none");
      }
      function setButtonLoading(button, isLoading) {
        button.textContent = isLoading ? "Loading..." : button.getAttribute("data-original-text") || "Get Weather";
        button.disabled = isLoading;
      }
      function showToast(message) {
        toastBody.textContent = message;
        new bootstrap.Toast(toastEl).show();
      }
      function showSpinner(show) {
        loadingSpinner.style.display = show ? "flex" : "none";
      }
      function enableAddToFavorites(city) {
        if (city) {
          favoriteCityInput.value = city;
          addFavoriteBtn.classList.remove("d-none");
          addFavoriteBtn.onclick = () => {
            saveFavorite(city);
            favoritesForm.submit();
          };
        } else {
          addFavoriteBtn.classList.add("d-none");
        }
      }

      /*** Favorites List Handling using localStorage ***/
      function loadFavorites() {
        const favorites = JSON.parse(localStorage.getItem("favorites")) || [];
        favoritesList.innerHTML = "";
        favorites.forEach((fav) => {
          const li = document.createElement("li");

          // Create a span that displays the favorite city
          const span = document.createElement("span");
          span.textContent = fav;
          span.addEventListener("click", () => {
            cityInput.value = fav;
            fetchWeather();
          });

          // Create a remove button
          const removeBtn = document.createElement("button");
          removeBtn.textContent = "Remove";
          removeBtn.className = "btn btn-sm btn-danger";
          removeBtn.addEventListener("click", (e) => {
            e.stopPropagation(); // Prevent triggering the span click
            removeFavorite(fav);
          });

          li.appendChild(span);
          li.appendChild(removeBtn);
          favoritesList.appendChild(li);
        });
      }
      function saveFavorite(city) {
        let favorites = JSON.parse(localStorage.getItem("favorites")) || [];
        if (!favorites.includes(city)) {
          favorites.push(city);
          localStorage.setItem("favorites", JSON.stringify(favorites));
          loadFavorites();
          showToast(`Saved ${city} as a favorite!`);
        }
      }
      function removeFavorite(city) {
        let favorites = JSON.parse(localStorage.getItem("favorites")) || [];
        favorites = favorites.filter(item => item !== city);
        localStorage.setItem("favorites", JSON.stringify(favorites));
        loadFavorites();
        showToast(`Removed ${city} from favorites.`);
      }

      /*** Autocomplete for City Input using GeoDB Cities API ***/
      cityInput.addEventListener("input", function () {
        const query = cityInput.value.trim();
        autocompleteSuggestions.innerHTML = "";
        if (query.length < 3) {  // Only query when at least 3 characters
          autocompleteSuggestions.style.display = "none";
          return;
        }
        // Fetch suggestions from the GeoDB Cities API
        fetch(`http://geodb-free-service.wirefreethought.com/v1/geo/cities?limit=5&namePrefix=${encodeURIComponent(query)}`)
          .then((res) => res.json())
          .then((data) => {
            autocompleteSuggestions.innerHTML = "";
            if (data.data && data.data.length > 0) {
              data.data.forEach((city) => {
                const suggestionItem = document.createElement("a");
                // Construct a label (city name and country)
                suggestionItem.textContent = `${city.city}, ${city.country}`;
                suggestionItem.href = "#";
                suggestionItem.addEventListener("click", function (e) {
                  e.preventDefault();
                  cityInput.value = city.city;
                  autocompleteSuggestions.innerHTML = "";
                  autocompleteSuggestions.style.display = "none";
                });
                autocompleteSuggestions.appendChild(suggestionItem);
              });
              autocompleteSuggestions.style.display = "block";
            } else {
              autocompleteSuggestions.style.display = "none";
            }
          })
          .catch((err) => {
            console.error("Error fetching city suggestions:", err);
            autocompleteSuggestions.style.display = "none";
          });
      });

      /*** Dark Mode Toggle with Persistence ***/
      toggleDarkModeBtn.addEventListener("click", () => {
        bodyEl.classList.toggle("dark-mode");
        if (bodyEl.classList.contains("dark-mode")) {
          localStorage.setItem("darkMode", "enabled");
          showToast("Dark mode enabled");
        } else {
          localStorage.setItem("darkMode", "disabled");
          showToast("Dark mode disabled");
        }
      });

      /*** Share Weather Feature ***/
      shareWeatherBtn.addEventListener("click", async () => {
        if (!lastWeatherData) {
          showToast("No weather data available to share.");
          return;
        }
        const shareText = `Weather for ${lastWeatherData.city}: ${lastWeatherData.weather_info}.` +
                          (lastWeatherData.temperature ? ` Temperature: ${lastWeatherData.temperature}.` : "");
        if (navigator.share) {
          try {
            await navigator.share({
              title: `Weather in ${lastWeatherData.city}`,
              text: shareText,
              url: window.location.href
            });
          } catch (error) {
            console.error("Error sharing", error);
            showToast("Error sharing weather data.");
          }
        } else {
          // Fallback: copy to clipboard
          navigator.clipboard.writeText(shareText).then(() => {
            showToast("Weather data copied to clipboard!");
          }, (err) => {
            console.error("Could not copy text: ", err);
            showToast("Could not copy weather data.");
          });
        }
      });

      /*** Event Listeners ***/
      getWeatherBtn.addEventListener("click", fetchWeather);
      detectLocationBtn.addEventListener("click", () => {
        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition(async (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            try {
              const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
              const data = await response.json();
              const detectedCity = data.address.city || data.address.town || data.address.village || data.address.county;
              if (detectedCity) {
                cityInput.value = detectedCity;
                showToast("Location detected: " + detectedCity);
                fetchWeather();
              } else {
                showToast("Unable to detect city from your location.");
              }
            } catch (error) {
              console.error("Reverse geocoding failed:", error);
              showToast("Reverse geocoding failed: " + error.message);
            }
          }, (error) => {
            console.error("Error getting location:", error);
            showToast("Error getting location: " + error.message);
          });
        } else {
          showToast("Geolocation is not supported by your browser.");
        }
      });
      toggleUnitBtn.addEventListener("click", fetchWeather);

      // Load favorites from localStorage when the page loads.
      loadFavorites();
    });
  </script>
{% endblock %}
